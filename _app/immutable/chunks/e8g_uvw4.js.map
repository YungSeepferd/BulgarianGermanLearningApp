{"version":3,"file":"e8g_uvw4.js","sources":["../../../../../../node_modules/.pnpm/svelte@5.46.0/node_modules/svelte/src/internal/client/dom/blocks/branches.js"],"sourcesContent":["/** @import { Effect, TemplateNode } from '#client' */\nimport { Batch, current_batch } from '../../reactivity/batch.js';\nimport {\n\tbranch,\n\tdestroy_effect,\n\tmove_effect,\n\tpause_effect,\n\tresume_effect\n} from '../../reactivity/effects.js';\nimport { hydrate_node, hydrating } from '../hydration.js';\nimport { create_text, should_defer_append } from '../operations.js';\n\n/**\n * @typedef {{ effect: Effect, fragment: DocumentFragment }} Branch\n */\n\n/**\n * @template Key\n */\nexport class BranchManager {\n\t/** @type {TemplateNode} */\n\tanchor;\n\n\t/** @type {Map<Batch, Key>} */\n\t#batches = new Map();\n\n\t/**\n\t * Map of keys to effects that are currently rendered in the DOM.\n\t * These effects are visible and actively part of the document tree.\n\t * Example:\n\t * ```\n\t * {#if condition}\n\t * \tfoo\n\t * {:else}\n\t * \tbar\n\t * {/if}\n\t * ```\n\t * Can result in the entries `true->Effect` and `false->Effect`\n\t * @type {Map<Key, Effect>}\n\t */\n\t#onscreen = new Map();\n\n\t/**\n\t * Similar to #onscreen with respect to the keys, but contains branches that are not yet\n\t * in the DOM, because their insertion is deferred.\n\t * @type {Map<Key, Branch>}\n\t */\n\t#offscreen = new Map();\n\n\t/**\n\t * Keys of effects that are currently outroing\n\t * @type {Set<Key>}\n\t */\n\t#outroing = new Set();\n\n\t/**\n\t * Whether to pause (i.e. outro) on change, or destroy immediately.\n\t * This is necessary for `<svelte:element>`\n\t */\n\t#transition = true;\n\n\t/**\n\t * @param {TemplateNode} anchor\n\t * @param {boolean} transition\n\t */\n\tconstructor(anchor, transition = true) {\n\t\tthis.anchor = anchor;\n\t\tthis.#transition = transition;\n\t}\n\n\t#commit = () => {\n\t\tvar batch = /** @type {Batch} */ (current_batch);\n\n\t\t// if this batch was made obsolete, bail\n\t\tif (!this.#batches.has(batch)) return;\n\n\t\tvar key = /** @type {Key} */ (this.#batches.get(batch));\n\n\t\tvar onscreen = this.#onscreen.get(key);\n\n\t\tif (onscreen) {\n\t\t\t// effect is already in the DOM â€” abort any current outro\n\t\t\tresume_effect(onscreen);\n\t\t\tthis.#outroing.delete(key);\n\t\t} else {\n\t\t\t// effect is currently offscreen. put it in the DOM\n\t\t\tvar offscreen = this.#offscreen.get(key);\n\n\t\t\tif (offscreen) {\n\t\t\t\tthis.#onscreen.set(key, offscreen.effect);\n\t\t\t\tthis.#offscreen.delete(key);\n\n\t\t\t\t// remove the anchor...\n\t\t\t\t/** @type {TemplateNode} */ (offscreen.fragment.lastChild).remove();\n\n\t\t\t\t// ...and append the fragment\n\t\t\t\tthis.anchor.before(offscreen.fragment);\n\t\t\t\tonscreen = offscreen.effect;\n\t\t\t}\n\t\t}\n\n\t\tfor (const [b, k] of this.#batches) {\n\t\t\tthis.#batches.delete(b);\n\n\t\t\tif (b === batch) {\n\t\t\t\t// keep values for newer batches\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tconst offscreen = this.#offscreen.get(k);\n\n\t\t\tif (offscreen) {\n\t\t\t\t// for older batches, destroy offscreen effects\n\t\t\t\t// as they will never be committed\n\t\t\t\tdestroy_effect(offscreen.effect);\n\t\t\t\tthis.#offscreen.delete(k);\n\t\t\t}\n\t\t}\n\n\t\t// outro/destroy all onscreen effects...\n\t\tfor (const [k, effect] of this.#onscreen) {\n\t\t\t// ...except the one that was just committed\n\t\t\t//    or those that are already outroing (else the transition is aborted and the effect destroyed right away)\n\t\t\tif (k === key || this.#outroing.has(k)) continue;\n\n\t\t\tconst on_destroy = () => {\n\t\t\t\tconst keys = Array.from(this.#batches.values());\n\n\t\t\t\tif (keys.includes(k)) {\n\t\t\t\t\t// keep the effect offscreen, as another batch will need it\n\t\t\t\t\tvar fragment = document.createDocumentFragment();\n\t\t\t\t\tmove_effect(effect, fragment);\n\n\t\t\t\t\tfragment.append(create_text()); // TODO can we avoid this?\n\n\t\t\t\t\tthis.#offscreen.set(k, { effect, fragment });\n\t\t\t\t} else {\n\t\t\t\t\tdestroy_effect(effect);\n\t\t\t\t}\n\n\t\t\t\tthis.#outroing.delete(k);\n\t\t\t\tthis.#onscreen.delete(k);\n\t\t\t};\n\n\t\t\tif (this.#transition || !onscreen) {\n\t\t\t\tthis.#outroing.add(k);\n\t\t\t\tpause_effect(effect, on_destroy, false);\n\t\t\t} else {\n\t\t\t\ton_destroy();\n\t\t\t}\n\t\t}\n\t};\n\n\t/**\n\t * @param {Batch} batch\n\t */\n\t#discard = (batch) => {\n\t\tthis.#batches.delete(batch);\n\n\t\tconst keys = Array.from(this.#batches.values());\n\n\t\tfor (const [k, branch] of this.#offscreen) {\n\t\t\tif (!keys.includes(k)) {\n\t\t\t\tdestroy_effect(branch.effect);\n\t\t\t\tthis.#offscreen.delete(k);\n\t\t\t}\n\t\t}\n\t};\n\n\t/**\n\t *\n\t * @param {any} key\n\t * @param {null | ((target: TemplateNode) => void)} fn\n\t */\n\tensure(key, fn) {\n\t\tvar batch = /** @type {Batch} */ (current_batch);\n\t\tvar defer = should_defer_append();\n\n\t\tif (fn && !this.#onscreen.has(key) && !this.#offscreen.has(key)) {\n\t\t\tif (defer) {\n\t\t\t\tvar fragment = document.createDocumentFragment();\n\t\t\t\tvar target = create_text();\n\n\t\t\t\tfragment.append(target);\n\n\t\t\t\tthis.#offscreen.set(key, {\n\t\t\t\t\teffect: branch(() => fn(target)),\n\t\t\t\t\tfragment\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.#onscreen.set(\n\t\t\t\t\tkey,\n\t\t\t\t\tbranch(() => fn(this.anchor))\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tthis.#batches.set(batch, key);\n\n\t\tif (defer) {\n\t\t\tfor (const [k, effect] of this.#onscreen) {\n\t\t\t\tif (k === key) {\n\t\t\t\t\tbatch.skipped_effects.delete(effect);\n\t\t\t\t} else {\n\t\t\t\t\tbatch.skipped_effects.add(effect);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (const [k, branch] of this.#offscreen) {\n\t\t\t\tif (k === key) {\n\t\t\t\t\tbatch.skipped_effects.delete(branch.effect);\n\t\t\t\t} else {\n\t\t\t\t\tbatch.skipped_effects.add(branch.effect);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tbatch.oncommit(this.#commit);\n\t\t\tbatch.ondiscard(this.#discard);\n\t\t} else {\n\t\t\tif (hydrating) {\n\t\t\t\tthis.anchor = hydrate_node;\n\t\t\t}\n\n\t\t\tthis.#commit();\n\t\t}\n\t}\n}\n"],"names":["BranchManager","constructor","anchor","transition","__publicField","this","__privateAdd","_batches","Map","_onscreen","_offscreen","_outroing","Set","_transition","_commit","batch","__privateGet","has","key","get","onscreen","resume_effect","delete","offscreen","set","effect","fragment","lastChild","remove","before","b","k","destroy_effect","on_destroy","Array","from","values","includes","document","createDocumentFragment","move_effect","append","create_text","add","pause_effect","_discard","keys","branch","ensure","fn","defer","should_defer_append","target","skipped_effects","oncommit","ondiscard","hydrating","hydrate_node","call","WeakMap"],"mappings":"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","x_google_ignoreList":[0]}