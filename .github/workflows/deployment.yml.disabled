name: Deployment Pipeline

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_ENV: ${{ github.ref == 'refs/heads/main' && 'staging' || github.ref_type == 'tag' && 'production' || 'development' }}
  BASE_PATH: ${{ github.ref == 'refs/heads/main' && '/staging' || github.ref_type == 'tag' && '' || '' }}

jobs:
  # Reuse existing CI quality gates
  ci-quality-gates:
    uses: ./.github/workflows/ci.yml

  # Build job for all environments
  build:
    name: Build Application
    needs: ci-quality-gates
    runs-on: ubuntu-latest
    outputs:
      build-version: ${{ steps.version.outputs.build-version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Set build version
        id: version
        run: |
          if [ "${{ github.ref_type }}" = "tag" ]; then
            echo "build-version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "build-version=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Build application
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-${{ steps.version.outputs.build-version }}
          path: |
            build/
            !build/.gitkeep
          retention-days: 7

  # Staging deployment
  deploy-staging:
    name: Deploy to Staging
    needs: build
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.bulgarianapp.com
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          name: build-${{ needs.build.outputs.build-version }}
          path: build

      - name: Deploy to GitHub Pages (Staging)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          destination_dir: staging
          keep_files: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy staging: ${{ github.event.head_commit.message }}'

      - name: Run post-deployment tests
        run: |
          echo "Running post-deployment tests for staging environment"
          # Add post-deployment test commands here

  # Production deployment
  deploy-production:
    name: Deploy to Production
    needs: [build, deploy-staging]
    if: github.ref_type == 'tag' || github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://bulgarianapp.com
    steps:
      - uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v6
        with:
          name: build-${{ needs.build.outputs.build-version }}
          path: build

      - name: Deploy to GitHub Pages (Production)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build
          keep_files: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy production: ${{ github.ref_name }}'

      - name: Run post-deployment tests
        run: |
          echo "Running post-deployment tests for production environment"
          # Add post-deployment test commands here

      - name: Create GitHub Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ## What's Changed
            ${{ github.event.head_commit.message }}

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ github.ref_name }}...${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Update existing CI workflow to include deployment support
  update-ci-workflow:
    name: Update CI Workflow
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update CI workflow to support deployment
        run: |
          # Update the CI workflow to include deployment-ready checks
          cat > .github/workflows/ci.yml.new << 'EOL'
          name: CI Quality Gates

          on:
            push:
              branches: [ main ]
            pull_request:
              branches: [ main ]
            workflow_call:

          jobs:
            lint-and-typecheck:
              name: Linting & Type Checking
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4

                - name: Setup pnpm
                  uses: pnpm/action-setup@v4
                  with:
                    version: 10

                - name: Setup Node.js
                  uses: actions/setup-node@v4
                  with:
                    node-version: 20
                    cache: 'pnpm'

                - name: Install dependencies
                  run: pnpm install

                - name: Run ESLint
                  run: pnpm lint:check

                - name: Run TypeScript type check
                  run: pnpm check

                - name: Run Svelte check
                  run: pnpm svelte-check

            unit-tests:
              name: Unit Tests
              runs-on: ubuntu-latest
              needs: lint-and-typecheck
              steps:
                - uses: actions/checkout@v4

                - name: Setup pnpm
                  uses: pnpm/action-setup@v4
                  with:
                    version: 10

                - name: Setup Node.js
                  uses: actions/setup-node@v4
                  with:
                    node-version: 20
                    cache: 'pnpm'

                - name: Install dependencies
                  run: pnpm install

                - name: Run unit tests with coverage
                  run: pnpm test:unit

                - name: Upload coverage report
                  uses: actions/upload-artifact@v5
                  with:
                    name: coverage-report
                    path: coverage/

            # Add deployment-ready check
            deployment-ready:
              name: Deployment Ready Check
              runs-on: ubuntu-latest
              needs: unit-tests
              steps:
                - uses: actions/checkout@v4

                - name: Setup pnpm
                  uses: pnpm/action-setup@v4

                - name: Setup Node.js
                  uses: actions/setup-node@v4
                  with:
                    node-version: 20
                    cache: 'pnpm'

                - name: Install dependencies
                  run: pnpm install

                - name: Check build succeeds
                  run: pnpm build

                - name: Run E2E tests
                  run: pnpm test:e2e

                - name: Run Accessibility tests
                  run: pnpm test:accessibility
          EOL

          # Replace the existing CI workflow
          mv .github/workflows/ci.yml.new .github/workflows/ci.yml

          # Commit the changes if there are differences
          if ! git diff --quiet .github/workflows/ci.yml; then
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add .github/workflows/ci.yml
            git commit -m "chore(ci): update workflow to support deployment [skip ci]"
            git push
          fi