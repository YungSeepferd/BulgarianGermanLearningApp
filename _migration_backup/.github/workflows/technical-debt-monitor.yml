name: Technical Debt Monitor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'

jobs:
  technical-debt-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Technical Debt Monitor
      run: node scripts/technical-debt-monitor.js
      
    - name: Upload Technical Debt Report
      uses: actions/upload-artifact@v4
      with:
        name: technical-debt-report
        path: |
          technical-debt-report.json
          technical-debt-report.html
          technical-debt-history.json
        retention-days: 30
        
    - name: Comment PR with Technical Debt Summary
      if: github.event_name == 'pull_request'
      run: |
        node scripts/generate-pr-comment.js
        
    - name: Check Type Safety Threshold
      run: |
        # Check if type safety score meets minimum threshold
        TYPE_SAFETY_SCORE=$(node -e "
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('technical-debt-report.json', 'utf8'));
          console.log(report.typeSafetyScore);
        ")
        
        echo "Type Safety Score: $TYPE_SAFETY_SCORE%"
        
        # Fail if type safety score is below 30%
        if (( $(echo "$TYPE_SAFETY_SCORE < 30" | bc -l) )); then
          echo "‚ùå Type safety score ($TYPE_SAFETY_SCORE%) is below minimum threshold (30%)"
          exit 1
        else
          echo "‚úÖ Type safety score ($TYPE_SAFETY_SCORE%) meets minimum threshold"
        fi
        
    - name: Check Error Count Threshold
      run: |
        # Check if error count is within acceptable limits
        ERROR_COUNT=$(node -e "
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('technical-debt-report.json', 'utf8'));
          console.log(report.problems.severity.error);
        ")
        
        echo "Error Count: $ERROR_COUNT"
        
        # Fail if error count is above 1000
        if [ "$ERROR_COUNT" -gt 1000 ]; then
          echo "‚ùå Error count ($ERROR_COUNT) exceeds maximum threshold (1000)"
          exit 1
        else
          echo "‚úÖ Error count ($ERROR_COUNT) is within acceptable limits"
        fi
        
    - name: Generate Trend Analysis
      if: github.event_name == 'push'
      run: |
        # Generate trend analysis for main branch pushes
        node -e "
          const fs = require('fs');
          const path = require('path');
          
          try {
            const history = JSON.parse(fs.readFileSync('technical-debt-history.json', 'utf8'));
            
            if (history.length >= 2) {
              const current = history[history.length - 1];
              const previous = history[history.length - 2];
              
              const problemDiff = current.problems.total - previous.problems.total;
              const errorDiff = current.problems.severity.error - previous.problems.severity.error;
              const scoreDiff = current.typeSafetyScore - previous.typeSafetyScore;
              
              console.log('üìà Trend Analysis:');
              console.log(\`   Problems: \${problemDiff > 0 ? '+' : ''}\${problemDiff}\`);
              console.log(\`   Errors: \${errorDiff > 0 ? '+' : ''}\${errorDiff}\`);
              console.log(\`   Type Safety Score: \${scoreDiff > 0 ? '+' : ''}\${scoreDiff.toFixed(1)}%\`);
              
              if (problemDiff > 10) {
                console.log('‚ö†Ô∏è  Technical debt is increasing significantly');
              } else if (problemDiff < -10) {
                console.log('‚úÖ Technical debt is decreasing significantly');
              }
            }
          } catch (error) {
            console.log('Could not generate trend analysis:', error.message);
          }
        "

  # Weekly detailed analysis job
  weekly-analysis:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run Comprehensive Technical Debt Analysis
      run: |
        echo "üîç Running comprehensive technical debt analysis..."
        node scripts/technical-debt-monitor.js
        
        # Generate additional metrics
        echo "üìä Generating additional metrics..."
        npx eslint assets/js/**/*.ts scripts/**/*.ts --format=json > eslint-full-report.json
        
        # Count lines of code
        echo "üìè Counting lines of code..."
        find assets/js scripts -name "*.ts" -not -path "*/node_modules/*" | xargs wc -l > loc-count.txt
        
    - name: Create Weekly Report Issue
      run: |
        node scripts/generate-weekly-report.js