name: CI
permissions:
  contents: read
  checks: write
  pull-requests: write

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install


      - name: Setup Hugo
        uses: peaceiris/actions-hugo@16361eb4acea8698b220b76c0d4e84e1fd22c61d # v2.6.0
        with:
          hugo-version: '0.148.2'
          extended: true

      - name: Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: '1.23'
          cache-dependency-path: tools/go.sum

      - name: Build Go tools
        run: npm run build-tools

      - name: Validate data
        run: npm run validate

      - name: Run lint checks
        run: npm run lint

      - name: Go unit tests
        run: go test ./...
        working-directory: tools

      - name: Run security audits
        run: |
          npm audit --audit-level=high
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...
        working-directory: tools

      - name: Build site
        run: npm run build

      - name: Install Svelte 5 compatible dependencies
        run: cd svelte-frontend && npm install

      - name: Install Playwright for Svelte 5
        run: cd svelte-frontend && npx playwright install --with-deps

      - name: Build Svelte 5 frontend
        run: cd svelte-frontend && npm run build

      - name: Run Svelte 5 unit tests
        run: cd svelte-frontend && npm run test:unit

      - name: Generate Svelte 5 coverage report
        run: cd svelte-frontend && npm run test:coverage

      - name: Upload Svelte 5 coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: svelte-frontend/coverage/coverage-final.json
          flags: svelte5-unittests
          name: codecov-svelte5
          fail_ci_if_error: false

      - name: Enforce Svelte 5 Coverage Threshold
        run: |
          cd svelte-frontend
          COVERAGE=$(node -e "console.log(require('./coverage/coverage-summary.json').total.lines.pct)")
          echo "Current Svelte 5 coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | node -e "process.exit(Math.floor(parseFloat(process.argv[1]) < 80) ? 1 : 0)") )); then
            echo "❌ Svelte 5 coverage ${COVERAGE}% is below 80% threshold"
            echo "Please add more tests to improve coverage before merging."
            exit 1
          else
            echo "✅ Svelte 5 coverage ${COVERAGE}% meets 80% minimum threshold"
          fi

      - name: Svelte 5 Coverage Diff Check
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "Running Svelte 5 coverage diff check for PR #${{ github.event.number }}"
            cd svelte-frontend && node scripts/coverage-diff.js
            echo "✅ Svelte 5 coverage diff check completed"
          else
            echo "Skipping Svelte 5 coverage diff check (not a pull request)"
          fi

      - name: Run Svelte 5 component tests
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
        run: cd svelte-frontend && npm run test:components

      - name: Run Svelte 5 accessibility tests
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
        run: cd svelte-frontend && npm run test:accessibility

      - name: Run Svelte 5 integration tests
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
        run: cd svelte-frontend && npm run test:integration

      - name: Run Svelte 5 CI test suite
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
        run: cd svelte-frontend && npm run test:ci

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse Results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci/

      - name: Upload Accessibility Test Results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: accessibility-test-results
          path: |
            test-results/
            playwright-report/
