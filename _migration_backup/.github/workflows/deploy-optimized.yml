name: Deploy to Production (Optimized)

permissions:
  contents: read
  pages: write
  id-token: write

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      rollback:
        description: 'Rollback to previous version'
        required: false
        type: boolean
        default: false
      force_deploy:
        description: 'Force deployment even if tests failed'
        required: false
        type: boolean
        default: false

concurrency:
  group: "pages-deploy"
  cancel-in-progress: false

env:
  NODE_VERSION: '20'
  GO_VERSION: '1.23'
  HUGO_VERSION: '0.148.2'

jobs:
  # Comprehensive testing
  comprehensive-tests:
    name: Comprehensive Test Suite
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: needs.pre-deploy-checks.outputs.should-deploy == 'true'
    outputs:
      tests-passed: ${{ steps.test-results.outputs.tests-passed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'svelte-frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd svelte-frontend
          npm ci --prefer-offline --no-audit

      - name: Install Playwright browsers
        run: |
          cd svelte-frontend
          npx playwright install --with-deps

      - name: Run Jest unit tests
        id: jest-tests
        run: |
          echo "ðŸ§ª Running Jest unit tests with coverage..."
          cd svelte-frontend
          if npm run test:unit -- --coverage --watchAll=false --ci; then
            echo "jest-passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Jest tests passed"
          else
            echo "jest-passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Jest tests failed"
            exit 1
          fi

      - name: Run Playwright component tests
        id: playwright-component
        run: |
          echo "ðŸŽ­ Running Playwright component tests..."
          cd svelte-frontend
          if npm run test:component; then
            echo "component-passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Playwright component tests passed"
          else
            echo "component-passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Playwright component tests failed"
            exit 1
          fi

      - name: Run Playwright E2E tests
        id: playwright-e2e
        run: |
          echo "ðŸŒ Running Playwright E2E tests..."
          cd svelte-frontend
          if npm run test:e2e; then
            echo "e2e-passed=true" >> $GITHUB_OUTPUT
            echo "âœ… Playwright E2E tests passed"
          else
            echo "e2e-passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Playwright E2E tests failed"
            exit 1
          fi

      - name: Generate test results summary
        id: test-results
        run: |
          cd svelte-frontend
          
          # Check if all tests passed
          if [ "${{ steps.jest-tests.outputs.jest-passed }}" == "true" ] && \
             [ "${{ steps.playwright-component.outputs.component-passed }}" == "true" ] && \
             [ "${{ steps.playwright-e2e.outputs.e2e-passed }}" == "true" ]; then
            echo "tests-passed=true" >> $GITHUB_OUTPUT
            echo "âœ… All tests passed successfully"
          else
            echo "tests-passed=false" >> $GITHUB_OUTPUT
            echo "âŒ Some tests failed"
            exit 1
          fi

      - name: Upload test coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-coverage-${{ github.run_number }}
          path: |
            svelte-frontend/coverage/
            svelte-frontend/playwright-report/
            svelte-frontend/test-results/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            svelte-frontend/junit.xml
            svelte-frontend/test-results/
          retention-days: 30

  # Pre-deployment validation
  pre-deploy-checks:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.validation.outputs.should-deploy }}
      deploy-version: ${{ steps.validation.outputs.deploy-version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate deployment readiness
        id: validation
        run: |
          echo "Checking deployment readiness..."
          
          # Check if this is a rollback request
          if [ "${{ github.event.inputs.rollback }}" == "true" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "deploy-version=rollback" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Rollback deployment requested"
            exit 0
          fi
          
          # Check if force deploy is requested
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "deploy-version=forced" >> $GITHUB_OUTPUT
            echo "âš¡ Force deployment requested"
            exit 0
          fi
          
          # Check if CI passed
          echo "Checking CI status..."
          CI_STATUS=$(gh run list --workflow="CI/CD Pipeline (Optimized)" --branch=main --limit=1 --json conclusion | jq -r '.[0].conclusion')
          
          if [ "$CI_STATUS" = "success" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "deploy-version=stable" >> $GITHUB_OUTPUT
            echo "âœ… CI passed, ready for deployment"
          elif [ "$CI_STATUS" = "failure" ]; then
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "deploy-version=failed" >> $GITHUB_OUTPUT
            echo "âŒ CI failed, deployment blocked"
            echo "Use force_deploy option to override"
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "deploy-version=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ CI status unknown, deployment blocked"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build and test deployment
  build-deployment:
    name: Build Deployment
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, comprehensive-tests]
    if: |
      needs.pre-deploy-checks.outputs.should-deploy == 'true' &&
      needs.comprehensive-tests.outputs.tests-passed == 'true'
    outputs:
      build-success: ${{ steps.build.outcome == 'success' }}
      build-hash: ${{ steps.hash.outputs.hash }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          ref: ${{ needs.pre-deploy-checks.outputs.deploy-version == 'rollback' && github.event.before || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: 'tools/go.sum'

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true

      - name: Generate build hash
        id: hash
        run: |
          BUILD_HASH=$(echo "${{ github.sha }}-${{ github.run_number }}" | sha256sum | cut -d' ' -f1)
          echo "hash=$BUILD_HASH" >> $GITHUB_OUTPUT
          echo "Build hash: $BUILD_HASH"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
            tools/bin
            node_modules
            svelte-frontend/node_modules
          key: ${{ runner.os }}-deploy-${{ steps.hash.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-deploy-
            ${{ runner.os }}-build-

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          cd svelte-frontend && npm ci --prefer-offline --no-audit

      - name: Build tools and process data
        run: |
          npm run build-tools
          npm run process-data
          npm run validate

      - name: Build Hugo site
        id: build
        env:
          HUGO_ENVIRONMENT: production
          HUGO_ENV: production
          NODE_ENV: production
          BUILD_HASH: ${{ steps.hash.outputs.hash }}
        run: |
          echo "Building with hash: $BUILD_HASH"
          hugo \
            --gc \
            --minify \
            --cleanDestinationDir \
            --enableGitInfo \
            --baseURL "${{ steps.pages.outputs.base_url }}/" || {
            echo "âŒ Hugo build failed"
            exit 1
          }
          
          # Add build info
          echo "Build completed successfully"
          echo "Commit: ${{ github.sha }}"
          echo "Build hash: $BUILD_HASH"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" > public/build-info.txt

      - name: Run deployment validation tests
        run: |
          echo "ðŸ” Running deployment validation tests..."
          
          # Check if critical files exist
          CRITICAL_FILES=("index.html" "sitemap.xml" "robots.txt")
          for file in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "public/$file" ]; then
              echo "âŒ Critical file missing: $file"
              exit 1
            fi
          done
          
          # Check file sizes
          if [ -f "public/index.html" ]; then
            SIZE=$(stat -c%s "public/index.html")
            if [ $SIZE -gt 1000000 ]; then
              echo "âš ï¸ Large index.html: $SIZE bytes"
            fi
          fi
          
          echo "âœ… Deployment validation passed"

      - name: Compress assets
        run: |
          echo "Optimizing assets..."
          find public -name "*.html" -exec gzip -k {} \;
          find public -name "*.css" -exec gzip -k {} \;
          find public -name "*.js" -exec gzip -k {} \;
          echo "âœ… Assets compressed"

      - name: Upload build artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  # Deploy with rollback capability
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, comprehensive-tests, build-deployment]
    if: |
      needs.pre-deploy-checks.outputs.should-deploy == 'true' &&
      needs.comprehensive-tests.outputs.tests-passed == 'true' &&
      needs.build-deployment.outputs.build-success == 'true'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Post-deployment verification
        run: |
          echo "Verifying deployment..."
          
          # Wait for deployment to be live
          sleep 30
          
          # Check if site is accessible
          if curl -f -s -o /dev/null -w "%{http_code}" "${{ steps.pages.outputs.base_url }}/" | grep -q "200"; then
            echo "âœ… Site is accessible"
          else
            echo "âŒ Site is not accessible"
            exit 1
          fi
          
          # Check critical pages
          CRITICAL_PAGES=("/" "/sitemap.xml" "/robots.txt")
          for page in "${CRITICAL_PAGES[@]}"; do
            if curl -f -s -o /dev/null "${{ steps.pages.outputs.base_url }}$page"; then
              echo "âœ… $page is accessible"
            else
              echo "âŒ $page is not accessible"
              exit 1
            fi
          done
          
          echo "âœ… Deployment verification completed"

      - name: Create deployment record
        run: |
          echo "Creating deployment record..."
          
          cat > deployment-record.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "build_hash": "${{ needs.build-deployment.outputs.build-hash }}",
            "deploy_version": "${{ needs.pre-deploy-checks.outputs.deploy-version }}",
            "deployment_url": "${{ steps.deployment.outputs.page_url }}",
            "actor": "${{ github.actor }}",
            "workflow_run": "${{ github.run_id }}",
            "rollback": ${{ needs.pre-deploy-checks.outputs.deploy-version == 'rollback' }}
          }
          EOF
          
          echo "Deployment record created"

      - name: Notify deployment success
        run: |
          echo "ðŸš€ Deployment completed successfully!"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo "Version: ${{ needs.pre-deploy-checks.outputs.deploy-version }}"
          echo "Build: ${{ needs.build-deployment.outputs.build-hash }}"

  # Health check after deployment
  health-check:
    name: Post-deployment Health Check
    runs-on: ubuntu-latest
    needs: deploy-production
    if: always()
    steps:
      - name: Wait for deployment
        run: sleep 60

      - name: Run health checks
        run: |
          echo "Running post-deployment health checks..."
          
          # Check site responsiveness
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "${{ needs.deploy-production.outputs.page_url }}/" || echo "failed")
          if [ "$RESPONSE_TIME" != "failed" ]; then
            if (( $(echo "$RESPONSE_TIME < 5.0" | bc -l) )); then
              echo "âœ… Site response time: ${RESPONSE_TIME}s"
            else
              echo "âš ï¸ Slow response time: ${RESPONSE_TIME}s"
            fi
          else
            echo "âŒ Site is not responding"
            exit 1
          fi
          
          # Check for critical errors
          if curl -s "${{ needs.deploy-production.outputs.page_url }}/" | grep -q "500\|error\|Error"; then
            echo "âš ï¸ Potential errors detected on homepage"
          else
            echo "âœ… No obvious errors detected"
          fi
          
          echo "âœ… Health checks completed"

  # Rollback trigger
  trigger-rollback:
    name: Trigger Rollback if Needed
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, comprehensive-tests, build-deployment, deploy-production, health-check]
    if: |
      failure() &&
      needs.pre-deploy-checks.outputs.should-deploy == 'true' &&
      needs.pre-deploy-checks.outputs.deploy-version != 'rollback'
    steps:
      - name: Trigger rollback workflow
        run: |
          echo "ðŸš¨ Deployment failed, triggering rollback..."
          
          gh workflow run deploy-optimized.yml \
            --field rollback=true \
            --field reason="Automated rollback due to deployment failure"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify rollback
        run: |
          echo "ðŸ”„ Rollback triggered automatically"
          echo "Failed deployment: ${{ github.sha }}"
          echo "Check the rollback workflow for status"

  # Deployment summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, comprehensive-tests, build-deployment, deploy-production, health-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-deploy Check | ${{ needs.pre-deploy-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Comprehensive Tests | ${{ needs.comprehensive-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-deployment.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | ${{ needs.health-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "âœ… **Deployment Successful**" >> $GITHUB_STEP_SUMMARY
            echo "- URL: ${{ needs.deploy-production.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
            echo "- Version: ${{ needs.pre-deploy-checks.outputs.deploy-version }}" >> $GITHUB_STEP_SUMMARY
            echo "- Build: ${{ needs.build-deployment.outputs.build-hash }}" >> $GITHUB_STEP_SUMMARY
            echo "- Tests: ${{ needs.comprehensive-tests.outputs.tests-passed }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment Failed**" >> $GITHUB_STEP_SUMMARY
            echo "- Check the logs for details" >> $GITHUB_STEP_SUMMARY
            echo "- Rollback may be triggered automatically" >> $GITHUB_STEP_SUMMARY
          fi