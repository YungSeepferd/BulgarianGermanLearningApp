class EnhancedPracticeSession{constructor(e={}){this.adapter=e.adapter,this.spacedRepetition=e.spacedRepetition,this.selectedItems=e.selectedItems||[],this.learningDirection=e.learningDirection||"bg_to_de",this.enableAudio=e.enableAudio||!1,this.sessionLength=e.sessionLength||20,this.currentSession=null,this.currentItemIndex=0,this.sessionStats={correct:0,total:0,startTime:null,responses:[]},this.sessionId=null,this.autoSaveInterval=null,this.elements={},this.initialized=!1}init(){if(this.initialized)return;this.cacheElements(),this.bindEvents(),this.checkForRecoverableSession()?this.showSessionRecoveryDialog():this.setupSession(),this.initialized=!0}cacheElements(){this.elements={loadingState:document.getElementById("loading-state"),noItemsState:document.getElementById("no-items-state"),practiceSession:document.getElementById("practice-session"),sessionComplete:document.getElementById("session-complete"),progress:document.getElementById("progress"),accuracy:document.getElementById("accuracy"),sessionTime:document.getElementById("session-time"),flashcard:document.getElementById("flashcard"),currentWord:document.getElementById("current-word"),currentTranslation:document.getElementById("current-translation"),currentNotes:document.getElementById("current-notes"),wordLevel:document.getElementById("word-level"),wordCategory:document.getElementById("word-category"),showAnswer:document.getElementById("show-answer"),responseButtons:document.getElementById("response-buttons"),correctBtn:document.getElementById("correct-btn"),incorrectBtn:document.getElementById("incorrect-btn"),playAudio:document.getElementById("play-audio"),showHint:document.getElementById("show-hint"),hintContent:document.getElementById("hint-content"),progressFill:document.getElementById("progress-fill"),endSession:document.getElementById("end-session"),settingsToggle:document.getElementById("settings-toggle"),settingsPanel:document.getElementById("settings-panel"),finalCorrect:document.getElementById("final-correct"),finalTotal:document.getElementById("final-total"),finalAccuracy:document.getElementById("final-accuracy"),finalTime:document.getElementById("final-time"),performanceFeedback:document.getElementById("performance-feedback"),newSession:document.getElementById("new-session"),reviewMistakes:document.getElementById("review-mistakes")}}bindEvents(){this.elements.showAnswer?.addEventListener("click",()=>this.showAnswer()),this.elements.correctBtn?.addEventListener("click",()=>this.recordResponse(!0)),this.elements.incorrectBtn?.addEventListener("click",()=>this.recordResponse(!1)),this.elements.playAudio?.addEventListener("click",()=>this.playAudio()),this.elements.showHint?.addEventListener("click",()=>this.toggleHint()),this.elements.endSession?.addEventListener("click",()=>this.endSession()),this.elements.settingsToggle?.addEventListener("click",()=>this.toggleSettings()),this.elements.newSession?.addEventListener("click",()=>this.startNewSession()),this.elements.reviewMistakes?.addEventListener("click",()=>this.reviewMistakes()),document.addEventListener("learning-direction-changed",e=>{this.learningDirection=e.detail.direction,this.setupSession()}),document.addEventListener("keydown",e=>this.handleKeyboard(e))}handleKeyboard(e){if(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA")return;if(e.key==="Tab"){document.body.classList.add("keyboard-navigation");return}switch(e.key){case" ":case"Enter":e.preventDefault(),this.elements.showAnswer&&!this.elements.showAnswer.classList.contains("hidden")?this.showAnswer():this.elements.flipCard&&!this.elements.flipCard.classList.contains("hidden")&&this.flipCard();break;case"1":e.preventDefault(),this.elements.responseButtons.classList.contains("hidden")||this.recordResponse(!1);break;case"2":e.preventDefault(),this.elements.responseButtons.classList.contains("hidden")||this.recordResponse(!0);break;case"h":case"H":e.preventDefault(),this.elements.showHint&&!this.elements.showHint.classList.contains("hidden")&&this.toggleHint();break;case"Escape":e.preventDefault(),this.elements.endSession&&this.endSession();break;case"ArrowLeft":case"ArrowRight":if(e.preventDefault(),!this.elements.responseButtons.classList.contains("hidden")){const t=this.elements.responseButtons.querySelectorAll(".btn"),s=document.activeElement,n=Array.from(t).indexOf(s);if(n!==-1){const s=e.key==="ArrowRight"?(n+1)%t.length:(n-1+t.length)%t.length;t[s].focus()}else t.length>0&&t[0].focus()}break}}async setupSession(){this.showLoadingState();try{if(this.selectedItems.length>0?this.currentSession=await this.createSelectedItemsSession():this.currentSession=await this.createSpacedRepetitionSession(),this.currentSession.items.length===0){this.showNoItemsState();return}this.sessionStats={correct:0,total:0,startTime:new Date,responses:[]},this.sessionId=this.generateSessionId(),this.currentItemIndex=0,this.startAutoSave(),this.showPracticeSession(),this.displayCurrentItem(),this.startTimer()}catch(e){console.error("Failed to setup practice session:",e),this.showNoItemsState()}}async createSelectedItemsSession(){const e=this.adapter.getItemsForDirection(this.learningDirection),t=e.filter(e=>this.selectedItems.includes(e.word)||this.selectedItems.includes(e.id)),n=this.shuffleArray([...t]);return{sessionId:this.generateSessionId(),learningMode:this.learningDirection,items:n.slice(0,this.sessionLength),startTime:new Date,type:"selected"}}async createSpacedRepetitionSession(){const e=this.adapter.getItemsForDirection(this.learningDirection);return this.spacedRepetition.createPracticeSession(e,{maxItems:this.sessionLength,learningMode:this.learningDirection,includeNew:!0})}displayCurrentItem(){if(!this.currentSession||this.currentItemIndex>=this.currentSession.items.length){this.completeSession();return}const t=this.getCurrentItem(),e=this.getVocabularyItem(t);if(!e){this.nextItem();return}this.resetFlashcard();const{word:n,translation:s}=this.getDisplayContent(e);this.elements.currentWord.textContent=n,this.elements.currentTranslation.textContent=s,this.elements.currentNotes.textContent=e.notes||"",this.elements.wordLevel.textContent=e.level||"A1",this.elements.wordLevel.className=`level-badge level-${(e.level||"A1").toLowerCase()}`,this.elements.wordCategory.textContent=e.category||"",this.setupAudio(e),this.setupHint(e),this.updateProgress(),this.currentItemStartTime=Date.now()}getCurrentItem(){return this.currentSession.type==="selected"?this.currentSession.items[this.currentItemIndex]:this.currentSession.items[this.currentItemIndex]}getVocabularyItem(e){if(e.itemId){const t=this.adapter.getItemsForDirection(this.learningDirection);return t.find(t=>t.id===e.itemId)}return e}getDisplayContent(e){return this.learningDirection==="de_to_bg"?{word:e.translation,translation:e.word}:{word:e.word,translation:e.translation}}setupAudio(e){if(!this.enableAudio||!this.elements.playAudio)return;e.audio?(this.elements.playAudio.style.display="block",this.elements.playAudio.dataset.audio=e.audio):this.elements.playAudio.style.display="none"}setupHint(e){if(!this.elements.showHint||!this.elements.hintContent)return;let t=[];if(e.etymology&&t.push(`Etymology: ${e.etymology}`),e.linguistic_note&&t.push(`Grammar: ${e.linguistic_note}`),e.cultural_note&&t.push(`Cultural: ${e.cultural_note}`),e.examples&&e.examples.length>0){const n=e.examples[0];t.push(`Example: ${n.text} → ${n.translation}`)}t.length>0?(this.elements.hintContent.innerHTML=t.map(e=>`<p>${e}</p>`).join(""),this.elements.showHint.style.display="block"):this.elements.showHint.style.display="none"}showAnswer(){this.elements.flashcard.classList.add("flipped"),this.elements.showAnswer.classList.add("hidden"),this.elements.responseButtons.classList.remove("hidden"),this.enableAudio&&setTimeout(()=>this.playAudio(),300)}playAudio(){const e=this.elements.playAudio?.dataset.audio;if(!e)return;const t=new Audio(`/audio/${e}`);t.play().catch(e=>{console.warn("Failed to play audio:",e)})}toggleHint(){const e=!this.elements.hintContent.classList.contains("hidden");e?(this.elements.hintContent.classList.add("hidden"),this.elements.showHint.textContent="💡 Hint"):(this.elements.hintContent.classList.remove("hidden"),this.elements.showHint.textContent="🔼 Hide Hint")}recordResponse(e){const s=this.getCurrentItem(),t=this.getVocabularyItem(s),n=this.currentItemStartTime?Date.now()-this.currentItemStartTime:0;this.sessionStats.total++,e&&this.sessionStats.correct++,this.sessionStats.responses.push({itemId:t.id,word:t.word,correct:e,responseTime:n,timestamp:new Date}),this.spacedRepetition&&this.spacedRepetition.recordReview(t.id,e,t,n),this.updateSessionStats(),this.updateProgress(),setTimeout(()=>{this.nextItem()},1e3)}nextItem(){this.currentItemIndex++,this.currentItemIndex>=this.currentSession.items.length?this.completeSession():this.displayCurrentItem()}resetFlashcard(){this.elements.flashcard.classList.remove("flipped"),this.elements.showAnswer.classList.remove("hidden"),this.elements.responseButtons.classList.add("hidden"),this.elements.hintContent.classList.add("hidden"),this.elements.showHint.textContent="💡 Hint"}updateProgress(){if(!this.currentSession||!this.elements.progress)return;const t=this.sessionStats.total,e=this.currentSession.items.length,n=Math.min(this.currentItemIndex+1,e),s=`${n}/${e}`;this.elements.progress.textContent=s;const o=t/e*100;this.elements.progressFill&&(this.elements.progressFill.style.width=`${Math.min(o,100)}%`)}updateSessionStats(){const e=this.sessionStats.total>0?Math.round(this.sessionStats.correct/this.sessionStats.total*100):0;this.elements.accuracy.textContent=`${e}%`}startTimer(){this.timerInterval=setInterval(()=>{const e=Date.now()-this.sessionStats.startTime,t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3);this.elements.sessionTime.textContent=`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},1e3)}completeSession(){this.timerInterval&&clearInterval(this.timerInterval);const e=Date.now()-this.sessionStats.startTime,t=this.sessionStats.total>0?Math.round(this.sessionStats.correct/this.sessionStats.total*100):0;this.elements.finalCorrect.textContent=this.sessionStats.correct,this.elements.finalTotal.textContent=this.sessionStats.total,this.elements.finalAccuracy.textContent=`${t}%`;const n=Math.floor(e/6e4),s=Math.floor(e%6e4/1e3);this.elements.finalTime.textContent=`${n}:${s.toString().padStart(2,"0")}`,this.generatePerformanceFeedback(t),localStorage.removeItem("bgde:practice_selection"),this.stopAutoSave(),this.clearSavedSession(),this.showSessionComplete()}generatePerformanceFeedback(e){let t="";e>=90?t="🌟 Ausgezeichnete Arbeit! Sie haben diese Wörter gemeistert. / Отлична работа! Овладяхте тези думи.":e>=75?t="👍 Gute Arbeit! Üben Sie weiter, um sich zu verbessern. / Добра работа! Продължете да упражнявате, за да се подобрите.":e>=60?t="📚 Nicht schlecht! Wiederholen Sie diese Wörter und versuchen Sie es erneut. / Неплохо! Прегледайте тези думи и опитайте отново.":t="💪 Üben Sie weiter! Diese Wörter brauchen mehr Aufmerksamkeit. / Продължете да упражнявате! Тези думи се нуждаят от повече внимание.",this.elements.performanceFeedback.innerHTML=`<p>${t}</p>`}endSession(){confirm("Sind Sie sicher, dass Sie diese Sitzung beenden möchten? / Сигурни ли сте, че искате да приключите тази сесия?")&&(this.stopAutoSave(),this.clearSavedSession(),this.completeSession())}toggleSettings(){this.elements.settingsPanel.classList.toggle("hidden")}startNewSession(){this.currentItemIndex=0,this.setupSession()}reviewMistakes(){const e=this.sessionStats.responses.filter(e=>!e.correct);if(e.length===0){alert("Keine Fehler zu überprüfen - großartige Arbeit! / Няма грешки за преглед - отлична работа!");return}const t=e.map(e=>e.word);localStorage.setItem("bgde:practice_selection",JSON.stringify(t)),this.selectedItems=t,this.setupSession()}showLoadingState(){this.hideAllStates(),this.elements.loadingState.classList.remove("hidden")}showNoItemsState(){this.hideAllStates(),this.elements.noItemsState.classList.remove("hidden")}showPracticeSession(){this.hideAllStates(),this.elements.practiceSession.classList.remove("hidden")}showSessionComplete(){this.hideAllStates(),this.elements.sessionComplete.classList.remove("hidden")}hideAllStates(){this.elements.loadingState.classList.add("hidden"),this.elements.noItemsState.classList.add("hidden"),this.elements.practiceSession.classList.add("hidden"),this.elements.sessionComplete.classList.add("hidden")}checkForRecoverableSession(){try{const t=localStorage.getItem("bgde:current_session");if(!t)return!1;const e=JSON.parse(t),n=Date.now(),s=n-e.lastSaved;return s<36e5&&e.currentItemIndex<e.items.length}catch(e){return console.warn("Error checking for recoverable session:",e),!1}}showSessionRecoveryDialog(){const e=JSON.parse(localStorage.getItem("bgde:current_session")),t=`${e.currentItemIndex}/${e.items.length}`,n=`Eine unvollständige Übungssitzung gefunden (${t} abgeschlossen). Möchten Sie dort weitermachen, wo Sie aufgehört haben? / Намерена е незавършена сесия за упражнения (${t} завършени). Искате ли да продължите от там, където спряхте?`;confirm(n)?this.recoverSession(e):(this.clearSavedSession(),this.setupSession())}recoverSession(e){this.sessionId=e.sessionId,this.currentSession=e,this.currentItemIndex=e.currentItemIndex,this.sessionStats=e.sessionStats,this.learningDirection=e.learningDirection,this.startAutoSave(),this.showCurrentItem(),this.showPracticeSession(),console.log("Session recovered successfully")}saveSession(){if(!this.currentSession||!this.sessionId)return;try{const e={sessionId:this.sessionId,items:this.currentSession.items,currentItemIndex:this.currentItemIndex,sessionStats:this.sessionStats,learningDirection:this.learningDirection,lastSaved:Date.now()};localStorage.setItem("bgde:current_session",JSON.stringify(e))}catch(e){console.warn("Error saving session:",e)}}clearSavedSession(){try{localStorage.removeItem("bgde:current_session")}catch(e){console.warn("Error clearing saved session:",e)}}startAutoSave(){this.autoSaveInterval&&clearInterval(this.autoSaveInterval),this.autoSaveInterval=setInterval(()=>{this.saveSession()},1e4)}stopAutoSave(){this.autoSaveInterval&&(clearInterval(this.autoSaveInterval),this.autoSaveInterval=null)}shuffleArray(e){const t=[...e];for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}typeof module!="undefined"&&module.exports&&(module.exports=EnhancedPracticeSession),typeof window!="undefined"&&(window.EnhancedPracticeSession=EnhancedPracticeSession)