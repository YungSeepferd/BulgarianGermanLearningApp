class EnhancedSpacedRepetition{constructor(){this.storagePrefix="bgde:",this.reviewStates=this.loadReviewStates(),this.currentDirection=localStorage.getItem("bgde:learning_direction")||"bg_to_de",this.difficultyMultipliers={bg_to_de:1.2,de_to_bg:1.1,both:1.15}}initReviewState(e,t=null){const n=t||this.currentDirection;return{itemId:e,learningMode:n,sourceLang:n==="de_to_bg"?"de":"bg",targetLang:n==="de_to_bg"?"bg":"de",interval:1,easeFactor:2.5,repetitions:0,nextReview:new Date,lastReview:null,correctStreak:0,totalReviews:0,successRate:0}}calculateNextReview(e,t,n=null){let o=e?5:2;n&&n.difficulty&&(e&&n.difficulty>=4?o=5:!e&&n.difficulty<=2&&(o=1));const s={...t,lastReview:new Date,totalReviews:t.totalReviews+1};e?s.correctStreak=t.correctStreak+1:s.correctStreak=0,s.successRate=s.correctStreak/s.totalReviews,o<3?(s.repetitions=0,s.interval=1):(s.repetitions=t.repetitions+1,s.repetitions===1?s.interval=1:s.repetitions===2?s.interval=6:s.interval=Math.round(s.interval*s.easeFactor));const r=this.getDirectionMultiplier(t.learningMode);s.interval=Math.round(s.interval*r);const a=o;s.easeFactor=s.easeFactor+(.1-(5-a)*(.08+(5-a)*.02)),s.easeFactor=Math.max(1.3,s.easeFactor);const i=new Date;return i.setDate(i.getDate()+s.interval),s.nextReview=i,s}getDirectionMultiplier(e){return this.difficultyMultipliers[e]||1}getDueItems(e=null){const t=e||this.currentDirection,n=new Date;return Object.values(this.reviewStates).filter(e=>{if(t!=="both"&&e.learningMode!==t)return!1;const s=new Date(e.nextReview);return s<=n})}getNewItems(e,t=null,n=5){const s=t||this.currentDirection,o=new Set(Object.keys(this.reviewStates));return e.filter(e=>!o.has(e.id)&&(s!=="bg_to_de"||e.source_lang==="bg")&&(s!=="de_to_bg"||e.source_lang==="de")).sort((e,t)=>e.difficulty!==t.difficulty?(e.difficulty||2)-(t.difficulty||2):(t.frequency||50)-(e.frequency||50)).slice(0,n)}createPracticeSession(e,t={}){const{maxItems:n=20,learningMode:s=this.currentDirection,includeNew:r=!0,targetLevel:a=null}=t;let o=this.getDueItems(s);if(a){const t=e.filter(e=>e.level===a),n=new Set(t.map(e=>e.id));o=o.filter(e=>n.has(e.itemId))}o.sort((e,t)=>{const n=new Date-new Date(e.nextReview),s=new Date-new Date(t.nextReview);return s-n});let i=o.slice(0,n);if(r&&i.length<n){const t=this.getNewItems(e,s,n-i.length);t.forEach(e=>{const t=this.initReviewState(e.id,s);i.push(t)})}return{sessionId:this.generateSessionId(),learningMode:s,items:i,startTime:new Date,targetLevel:a,maxItems:n}}recordReview(e,t,n=null,s=null){let o=this.reviewStates[e];o||(o=this.initReviewState(e,this.currentDirection));const i=this.calculateNextReview(t,o,n);return s!==null&&(i.lastResponseTime=s),this.reviewStates[e]=i,this.saveReviewStates(),i}getProgressStats(e=null){const t=e||this.currentDirection,o=Object.values(this.reviewStates),n=o.filter(e=>t==="both"||e.learningMode===t),s=n.length,i=this.getDueItems(t).length,a=n.filter(e=>e.repetitions>=3&&e.successRate>=.8).length,r=s>0?n.reduce((e,t)=>e+t.successRate,0)/s:0;return{totalItems:s,dueItems:i,masteredItems:a,averageSuccessRate:r,learningMode:t,lastUpdated:new Date}}loadReviewStates(){try{const e=localStorage.getItem(this.storagePrefix+"review_states");return e?JSON.parse(e):{}}catch(e){return console.warn("Failed to load review states:",e),{}}}saveReviewStates(){try{localStorage.setItem(this.storagePrefix+"review_states",JSON.stringify(this.reviewStates))}catch(e){console.warn("Failed to save review states:",e)}}exportData(){return{reviewStates:this.reviewStates,exportDate:(new Date).toISOString(),version:"1.0"}}importData(e){try{return!!(e.reviewStates&&typeof e.reviewStates=="object")&&(this.reviewStates=e.reviewStates,this.saveReviewStates(),!0)}catch(e){return console.error("Failed to import data:",e),!1}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}typeof module!="undefined"&&module.exports&&(module.exports=EnhancedSpacedRepetition),typeof window!="undefined"&&(window.EnhancedSpacedRepetition=EnhancedSpacedRepetition)