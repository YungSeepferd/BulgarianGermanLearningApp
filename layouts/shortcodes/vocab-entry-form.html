{{/*
  Vocabulary Entry Form Shortcode
  Usage: {{< vocab-entry-form >}}
*/}}

<div class="vocab-entry-container">
  <div class="entry-form-wrapper">
    <div class="form-tabs">
      <button class="tab-btn active" data-tab="manual">üìù Manual Entry</button>
      <button class="tab-btn" data-tab="import">üì• Import CSV/JSON</button>
      <button class="tab-btn" data-tab="manage">‚öôÔ∏è Manage Entries</button>
      <button class="tab-btn" data-tab="export">üíæ Export Data</button>
    </div>

    <!-- Manual Entry Tab -->
    <div class="tab-content active" id="manual-tab">
      <form id="vocab-entry-form" class="vocab-form">
        <div class="form-group">
          <label for="bulgarian">Bulgarian Word/Phrase *</label>
          <input
            type="text"
            id="bulgarian"
            name="bulgarian"
            placeholder="e.g., –ó–¥—Ä–∞–≤–µ–π"
            required
            class="form-input"
          />
        </div>

        <div class="form-group">
          <label for="german">German Word/Phrase *</label>
          <input
            type="text"
            id="german"
            name="german"
            placeholder="e.g., Hallo"
            required
            class="form-input"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="category">Category *</label>
            <select id="category" name="category" required class="form-input">
              <option value="">Select Category</option>
              <option value="Greetings">Greetings</option>
              <option value="Food">Food</option>
              <option value="Numbers">Numbers</option>
              <option value="Travel">Travel</option>
              <option value="Business">Business</option>
              <option value="Education">Education</option>
              <option value="Health">Health</option>
              <option value="Culture">Culture</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="level">CEFR Level *</label>
            <select id="level" name="level" required class="form-input">
              <option value="">Select Level</option>
              <option value="A1">A1 - Beginner</option>
              <option value="A2">A2 - Elementary</option>
              <option value="B1">B1 - Intermediate</option>
              <option value="B2">B2 - Upper Intermediate</option>
              <option value="C1">C1 - Advanced</option>
              <option value="C2">C2 - Mastery</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="cultural_note">Cultural Note (optional)</label>
          <textarea
            id="cultural_note"
            name="cultural_note"
            placeholder="Add cultural context or usage tips..."
            class="form-input"
            rows="2"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="linguistic_note">Linguistic Note (optional)</label>
          <textarea
            id="linguistic_note"
            name="linguistic_note"
            placeholder="Add grammatical or linguistic notes..."
            class="form-input"
            rows="2"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="examples">Example Sentences (optional)</label>
          <textarea
            id="examples"
            name="examples"
            placeholder="Enter examples in JSON format: [{&quot;bulgarian&quot;: &quot;...&quot;, &quot;german&quot;: &quot;...&quot;}]"
            class="form-input"
            rows="3"
          ></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary">Add Entry</button>
          <button type="reset" class="btn-secondary">Clear</button>
        </div>

        <div id="form-message" class="form-message" style="display: none;"></div>
      </form>
    </div>

    <!-- Import Tab -->
    <div class="tab-content" id="import-tab">
      <div class="import-section">
        <h3>Import from CSV</h3>
        <p class="help-text">CSV should have headers: bulgarian, german, category, level, cultural_note, linguistic_note, examples</p>
        <textarea
          id="csv-import"
          class="form-input"
          placeholder="Paste CSV content here or upload a file..."
          rows="8"
        ></textarea>
        <button id="import-csv-btn" class="btn-primary">Import CSV</button>

        <div class="divider">or</div>

        <h3>Import from JSON</h3>
        <p class="help-text">Upload a JSON file with vocabulary entries</p>
        <textarea
          id="json-import"
          class="form-input"
          placeholder="Paste JSON content here..."
          rows="8"
        ></textarea>
        <button id="import-json-btn" class="btn-primary">Import JSON</button>

        <div id="import-message" class="form-message" style="display: none;"></div>
      </div>
    </div>

    <!-- Manage Tab -->
    <div class="tab-content" id="manage-tab">
      <div class="manage-section">
        <div class="manage-header">
          <h3>Your Custom Entries</h3>
          <div class="manage-stats">
            <span id="custom-count">0 custom entries</span>
            <button id="clear-all-btn" class="btn-danger btn-small">Clear All</button>
          </div>
        </div>

        <div id="entries-list" class="entries-list">
          <p class="empty-state">No custom entries yet. Start by adding one above!</p>
        </div>
      </div>
    </div>

    <!-- Export Tab -->
    <div class="tab-content" id="export-tab">
      <div class="export-section">
        <h3>Export Vocabulary Data</h3>

        <div class="export-options">
          <div class="option">
            <label>
              <input type="checkbox" id="include-base" checked />
              Include base vocabulary
            </label>
            <p class="help-text">Check to include original vocabulary data in export</p>
          </div>
        </div>

        <div class="export-buttons">
          <button id="export-json-btn" class="btn-primary">Export as JSON</button>
          <button id="export-csv-btn" class="btn-primary">Export as CSV</button>
        </div>

        <div class="export-info">
          <h4>üìù How to Update GitHub</h4>
          <ol>
            <li>Export your vocabulary as JSON</li>
            <li>Replace the contents of <code>data/vocabulary.json</code> in your GitHub repo</li>
            <li>Commit and push the changes</li>
            <li>Your changes will be published to the live site automatically</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .vocab-entry-container {
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
  }

  .form-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid var(--color-border);
    flex-wrap: wrap;
  }

  .tab-btn {
    padding: 0.75rem 1rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 0.95rem;
    color: var(--color-text-secondary);
    transition: all 0.2s ease;
  }

  .tab-btn:hover {
    color: var(--color-primary);
  }

  .tab-btn.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }

  .tab-content {
    display: none;
    animation: fadeIn 0.2s ease;
  }

  .tab-content.active {
    display: block;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .vocab-form {
    display: grid;
    gap: 1.5rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
  }

  .form-group label {
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-input {
    padding: 0.75rem;
    border: 1px solid var(--color-border);
    border-radius: 0.375rem;
    font-size: 1rem;
    font-family: inherit;
    background: var(--color-background);
    color: var(--color-text);
  }

  .form-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-light);
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
  }

  .btn-primary,
  .btn-secondary,
  .btn-danger {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 1rem;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: var(--color-primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--color-primary-dark);
    transform: translateY(-2px);
  }

  .btn-secondary {
    background: var(--color-border);
    color: var(--color-text);
  }

  .btn-secondary:hover {
    background: var(--color-text-secondary);
  }

  .btn-danger {
    background: var(--color-error);
    color: white;
  }

  .btn-danger:hover {
    background: var(--color-error-dark);
  }

  .btn-small {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }

  .form-message {
    padding: 1rem;
    border-radius: 0.375rem;
    margin-top: 1rem;
  }

  .form-message.success {
    background: var(--color-success-light);
    color: var(--color-success-dark);
    border: 1px solid var(--color-success);
  }

  .form-message.error {
    background: var(--color-error-light);
    color: var(--color-error-dark);
    border: 1px solid var(--color-error);
  }

  .help-text {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-top: 0.25rem;
  }

  .divider {
    text-align: center;
    margin: 2rem 0;
    color: var(--color-text-secondary);
    position: relative;
  }

  .divider::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 0;
    right: 0;
    border-top: 1px solid var(--color-border);
  }

  .divider {
    position: relative;
    background: var(--color-background);
    display: inline-block;
    width: 100%;
    text-align: center;
  }

  .divider::after {
    content: "or";
    position: relative;
    background: var(--color-background);
    padding: 0 1rem;
  }

  .entries-list {
    display: grid;
    gap: 1rem;
  }

  .entry-item {
    padding: 1rem;
    border: 1px solid var(--color-border);
    border-radius: 0.375rem;
    background: var(--color-background-secondary);
  }

  .entry-item-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.5rem;
  }

  .entry-item-title {
    font-weight: 600;
    color: var(--color-text);
  }

  .entry-item-meta {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .entry-item-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .btn-edit,
  .btn-delete {
    padding: 0.4rem 0.8rem;
    font-size: 0.8rem;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
  }

  .btn-edit {
    background: var(--color-info);
    color: white;
  }

  .btn-delete {
    background: var(--color-error);
    color: white;
  }

  .empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-secondary);
  }

  .manage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .manage-stats {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .export-options {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .export-options .option {
    margin-bottom: 1rem;
  }

  .export-buttons {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .export-info {
    background: var(--color-background-secondary);
    padding: 1.5rem;
    border-radius: 0.375rem;
    border-left: 4px solid var(--color-primary);
  }

  .export-info h4 {
    margin-top: 0;
  }

  .export-info ol {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  .export-info li {
    margin-bottom: 0.5rem;
  }

  .export-info code {
    background: var(--color-background);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: monospace;
  }

  @media (max-width: 640px) {
    .form-row {
      grid-template-columns: 1fr;
    }

    .form-tabs {
      gap: 0.25rem;
    }

    .tab-btn {
      padding: 0.5rem 0.75rem;
      font-size: 0.85rem;
    }

    .export-buttons {
      flex-direction: column;
    }
  }
</style>

<script>
  /**
   * VocabularyManager Class - Inline for reliable shortcode use
   */
  class VocabularyManager {
    constructor(options = {}) {
      this.storageKey = 'bgde:custom_vocabulary';
      this.baseVocabulary = options.baseVocabulary || [];
      this.customVocabulary = this.loadCustomVocabulary();
    }
    loadCustomVocabulary() {
      try {
        const data = localStorage.getItem(this.storageKey);
        return data ? JSON.parse(data) : [];
      } catch (error) {
        console.error('[VocabularyManager] Error loading:', error);
        return [];
      }
    }
    saveCustomVocabulary() {
      try {
        localStorage.setItem(this.storageKey, JSON.stringify(this.customVocabulary));
        return true;
      } catch (error) {
        console.error('[VocabularyManager] Error saving:', error);
        return false;
      }
    }
    validateEntry(entry) {
      const errors = [];
      if (!entry.bulgarian || entry.bulgarian.trim() === '') errors.push('Bulgarian translation is required');
      if (!entry.german || entry.german.trim() === '') errors.push('German translation is required');
      if (!entry.category || entry.category.trim() === '') errors.push('Category is required');
      if (!entry.level) errors.push('CEFR level is required');
      else if (!['A1', 'A2', 'B1', 'B2', 'C1', 'C2'].includes(entry.level)) errors.push('Invalid CEFR level');
      if (entry.examples && !Array.isArray(entry.examples)) errors.push('Examples must be an array');
      return { isValid: errors.length === 0, errors };
    }
    createEntry(data) {
      const entry = {
        id: this.generateId(),
        bulgarian: data.bulgarian?.trim() || '',
        german: data.german?.trim() || '',
        category: data.category?.trim() || '',
        level: data.level || 'A1',
        cultural_note: data.cultural_note?.trim() || '',
        linguistic_note: data.linguistic_note?.trim() || '',
        examples: Array.isArray(data.examples) ? data.examples : [],
        source: 'manual',
        created_at: new Date().toISOString()
      };
      const validation = this.validateEntry(entry);
      if (!validation.isValid) return { success: false, errors: validation.errors, entry: null };
      this.customVocabulary.push(entry);
      this.saveCustomVocabulary();
      return { success: true, errors: [], entry };
    }
    deleteEntry(id) {
      const index = this.customVocabulary.findIndex(e => e.id === id);
      if (index === -1) return false;
      this.customVocabulary.splice(index, 1);
      this.saveCustomVocabulary();
      return true;
    }
    getCustomEntries() {
      return [...this.customVocabulary];
    }
    getMergedVocabulary() {
      return [...this.baseVocabulary, ...this.customVocabulary];
    }
    generateId() {
      const timestamp = Date.now();
      const random = Math.random().toString(36).substring(2, 9);
      return `custom_${timestamp}_${random}`;
    }
    exportAsJSON(includeBase = true) {
      const vocabulary = includeBase ? this.getMergedVocabulary() : this.customVocabulary;
      return JSON.stringify(vocabulary, null, 2);
    }
    exportAsCSV(includeBase = true) {
      const vocabulary = includeBase ? this.getMergedVocabulary() : this.customVocabulary;
      const headers = ['id', 'bulgarian', 'german', 'category', 'level', 'cultural_note', 'linguistic_note', 'examples', 'source'];
      const rows = vocabulary.map(item => [
        item.id || '',
        this.escapeCsvValue(item.bulgarian),
        this.escapeCsvValue(item.german),
        item.category || '',
        item.level || '',
        this.escapeCsvValue(item.cultural_note || ''),
        this.escapeCsvValue(item.linguistic_note || ''),
        this.escapeCsvValue(JSON.stringify(item.examples || [])),
        item.source || 'base'
      ]);
      return [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
    }
    escapeCsvValue(value) {
      if (typeof value !== 'string') value = String(value);
      if (value.includes(',') || value.includes('"') || value.includes('\n')) {
        return `"${value.replace(/"/g, '""')}"`;
      }
      return value;
    }
    importFromCSV(csvData) {
      const lines = csvData.trim().split('\n');
      if (lines.length < 2) return { success: false, message: 'CSV must have headers and at least one data row', imported: [] };
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      const imported = [];
      const errors = [];
      for (let i = 1; i < lines.length; i++) {
        const values = this.parseCSVLine(lines[i]);
        const entry = {};
        headers.forEach((header, index) => { entry[header] = values[index]?.trim() || ''; });
        if (!entry.bulgarian && !entry.german) continue;
        const result = this.createEntry(entry);
        if (result.success) imported.push(result.entry);
        else errors.push({ row: i + 1, errors: result.errors });
      }
      return { success: errors.length === 0, message: `Imported ${imported.length} entries${errors.length > 0 ? `, ${errors.length} errors` : ''}`, imported, errors };
    }
    parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];
        if (char === '"') {
          if (inQuotes && nextChar === '"') { current += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }
    importFromJSON(jsonData) {
      try {
        const entries = JSON.parse(jsonData);
        if (!Array.isArray(entries)) return { success: false, message: 'JSON must be an array', imported: [] };
        const imported = [];
        const errors = [];
        entries.forEach((entry, index) => {
          const result = this.createEntry(entry);
          if (result.success) imported.push(result.entry);
          else errors.push({ index, errors: result.errors });
        });
        return { success: errors.length === 0, message: `Imported ${imported.length} entries${errors.length > 0 ? `, ${errors.length} errors` : ''}`, imported, errors };
      } catch (error) {
        return { success: false, message: `JSON parse error: ${error.message}`, imported: [] };
      }
    }
    clearCustomVocabulary() {
      this.customVocabulary = [];
      this.saveCustomVocabulary();
      return true;
    }
  }

  // Initialize
  let vocabManager;

  function initializeForm() {
      // Try to get base vocabulary
      let baseVocabulary = [];
      if (window.vocabulary && Array.isArray(window.vocabulary)) {
        baseVocabulary = window.vocabulary;
      }

      vocabManager = new VocabularyManager({
        baseVocabulary
      });

      setupEventListeners();
      updateCustomEntriesDisplay();
    }

  function setupEventListeners() {
    // Tab switching
    document.querySelectorAll(".tab-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        switchTab(btn.dataset.tab);
      });
    });

    // Manual entry form
    document.getElementById("vocab-entry-form").addEventListener("submit", (e) => {
      e.preventDefault();
      handleManualEntry();
    });

    // Import buttons
    document.getElementById("import-csv-btn").addEventListener("click", handleCSVImport);
    document.getElementById("import-json-btn").addEventListener("click", handleJSONImport);

    // Export buttons
    document.getElementById("export-json-btn").addEventListener("click", () => handleExport("json"));
    document.getElementById("export-csv-btn").addEventListener("click", () => handleExport("csv"));

    // Clear all button
    document.getElementById("clear-all-btn").addEventListener("click", handleClearAll);
  }

  function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll(".tab-content").forEach((tab) => {
      tab.classList.remove("active");
    });

    // Deactivate all buttons
    document.querySelectorAll(".tab-btn").forEach((btn) => {
      btn.classList.remove("active");
    });

    // Show selected tab
    document.getElementById(`${tabName}-tab`).classList.add("active");

    // Activate selected button
    document.querySelector(`[data-tab="${tabName}"]`).classList.add("active");

    if (tabName === "manage") {
      updateCustomEntriesDisplay();
    }
  }

  function handleManualEntry() {
    const form = document.getElementById("vocab-entry-form");
    const formData = new FormData(form);

    const entry = {
      bulgarian: formData.get("bulgarian"),
      german: formData.get("german"),
      category: formData.get("category"),
      level: formData.get("level"),
      cultural_note: formData.get("cultural_note"),
      linguistic_note: formData.get("linguistic_note")
    };

    // Parse examples if provided
    const examplesStr = formData.get("examples");
    if (examplesStr && examplesStr.trim()) {
      try {
        entry.examples = JSON.parse(examplesStr);
      } catch (e) {
        showMessage("form-message", `Invalid examples JSON: ${e.message}`, "error");
        return;
      }
    }

    const result = vocabManager.createEntry(entry);

    if (result.success) {
      showMessage("form-message", `‚úÖ Entry added successfully!`, "success");
      form.reset();
      updateCustomEntriesDisplay();
    } else {
      showMessage("form-message", `‚ùå Validation errors:\n${result.errors.join("\n")}`, "error");
    }
  }

  function handleCSVImport() {
    const csvData = document.getElementById("csv-import").value;
    if (!csvData.trim()) {
      showMessage("import-message", "Please enter CSV data", "error");
      return;
    }

    const result = vocabManager.importFromCSV(csvData);
    if (result.success) {
      showMessage("import-message", `‚úÖ ${result.message}`, "success");
      document.getElementById("csv-import").value = "";
      updateCustomEntriesDisplay();
    } else {
      showMessage("import-message", `‚ùå ${result.message}`, "error");
    }
  }

  function handleJSONImport() {
    const jsonData = document.getElementById("json-import").value;
    if (!jsonData.trim()) {
      showMessage("import-message", "Please enter JSON data", "error");
      return;
    }

    const result = vocabManager.importFromJSON(jsonData);
    if (result.success) {
      showMessage("import-message", `‚úÖ ${result.message}`, "success");
      document.getElementById("json-import").value = "";
      updateCustomEntriesDisplay();
    } else {
      showMessage("import-message", `‚ùå ${result.message}`, "error");
    }
  }

  function handleExport(format) {
    const includeBase = document.getElementById("include-base").checked;
    let content, filename, mimeType;

    if (format === "json") {
      content = vocabManager.exportAsJSON(includeBase);
      filename = "vocabulary.json";
      mimeType = "application/json";
    } else {
      content = vocabManager.exportAsCSV(includeBase);
      filename = "vocabulary.csv";
      mimeType = "text/csv";
    }

    downloadFile(content, filename, mimeType);
  }

  function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function updateCustomEntriesDisplay() {
    const entries = vocabManager.getCustomEntries();
    const listContainer = document.getElementById("entries-list");
    const countDisplay = document.getElementById("custom-count");

    countDisplay.textContent = `${entries.length} custom entr${entries.length === 1 ? "y" : "ies"}`;

    if (entries.length === 0) {
      listContainer.innerHTML = '<p class="empty-state">No custom entries yet. Start by adding one above!</p>';
      return;
    }

    listContainer.innerHTML = entries
      .map(
        (entry) => `
      <div class="entry-item">
        <div class="entry-item-header">
          <div>
            <div class="entry-item-title">${entry.bulgarian} / ${entry.german}</div>
            <div class="entry-item-meta">${entry.category} ‚Ä¢ ${entry.level}</div>
          </div>
        </div>
        <div class="entry-item-buttons">
          <button class="btn-delete" onclick="deleteEntry('${entry.id}')">Delete</button>
        </div>
      </div>
    `
      )
      .join("");

    // Make delete work in global scope
    window.deleteEntry = (id) => {
      if (confirm("Delete this entry?")) {
        vocabManager.deleteEntry(id);
        updateCustomEntriesDisplay();
      }
    };
  }

  function handleClearAll() {
    if (confirm("Are you sure you want to delete ALL custom entries? This cannot be undone.")) {
      vocabManager.clearCustomVocabulary();
      updateCustomEntriesDisplay();
      showMessage("form-message", "All custom entries cleared", "success");
    }
  }

  function showMessage(elementId, message, type) {
    const element = document.getElementById(elementId);
    element.textContent = message;
    element.className = `form-message ${type}`;
    element.style.display = "block";
  }

  // Initialize on page load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeForm);
  } else {
    initializeForm();
  }
</script>
