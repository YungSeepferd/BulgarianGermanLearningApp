{{/* 
  Vocabulary Search Shortcode - Server-side search with Hugo data templates
  Usage: {{< vocab-search >}}
*/}}

{{/* Build search index from vocabulary data */}}
{{ $searchIndex := slice }}
{{ range .Site.Data.vocabulary }}
  {{ $item := dict 
    "id" .id
    "word" .word
    "translation" .translation
    "category" .category
    "level" .level
    "notes" (.notes | default "")
    "etymology" (.etymology | default "")
    "cultural_note" (.cultural_note | default "")
    "linguistic_note" (.linguistic_note | default "")
    "difficulty" (.difficulty | default 1)
    "frequency" (.frequency | default 1)
    "searchText" (printf "%s %s %s %s %s %s" .word .translation .category (.notes | default "") (.etymology | default "") (.cultural_note | default ""))
  }}
  {{ $searchIndex = $searchIndex | append $item }}
{{ end }}

<div class="vocab-search-container">
  <div class="search-header">
    <h2>Search Vocabulary</h2>
    <p>Search through {{ len .Site.Data.vocabulary }} vocabulary items</p>
  </div>
  
  <div class="search-controls">
    <div class="search-input-group">
      <input type="text" 
             id="search-query" 
             placeholder="Search words, translations, or notes..." 
             oninput="performSearch()"
             autocomplete="off">
      <button onclick="clearSearch()" class="clear-btn" title="Clear search">×</button>
    </div>
    
    <div class="search-filters">
      <select id="search-level" onchange="performSearch()">
        <option value="">All Levels</option>
        {{ $levels := slice }}
        {{ range .Site.Data.vocabulary }}
          {{ $levels = $levels | append .level }}
        {{ end }}
        {{ range ($levels | uniq | sort) }}
        <option value="{{ . }}">{{ . }}</option>
        {{ end }}
      </select>
      
      <select id="search-category" onchange="performSearch()">
        <option value="">All Categories</option>
        {{ $categories := slice }}
        {{ range .Site.Data.vocabulary }}
          {{ $categories = $categories | append .category }}
        {{ end }}
        {{ range ($categories | uniq | sort) }}
        <option value="{{ . }}">{{ . }}</option>
        {{ end }}
      </select>
      
      <select id="search-sort" onchange="performSearch()">
        <option value="relevance">Sort by Relevance</option>
        <option value="alphabetical">Sort Alphabetically</option>
        <option value="difficulty">Sort by Difficulty</option>
        <option value="frequency">Sort by Frequency</option>
      </select>
    </div>
  </div>
  
  <div class="search-stats">
    <span id="search-results-count">{{ len .Site.Data.vocabulary }} items</span>
    <span id="search-time"></span>
  </div>
  
  <div class="search-results" id="search-results">
    <div class="initial-message">
      <p>Start typing to search vocabulary items...</p>
      <div class="search-suggestions">
        <h4>Popular searches:</h4>
        <button onclick="searchFor('Begrüßung')" class="suggestion-btn">Greetings</button>
        <button onclick="searchFor('Familie')" class="suggestion-btn">Family</button>
        <button onclick="searchFor('Essen')" class="suggestion-btn">Food</button>
        <button onclick="searchFor('A1')" class="suggestion-btn">A1 Level</button>
      </div>
    </div>
  </div>
  
  <div class="no-results hidden" id="no-results">
    <h3>No results found</h3>
    <p>Try adjusting your search terms or filters.</p>
    <button onclick="clearSearch()" class="btn-secondary">Clear Search</button>
  </div>
</div>

<script id="search-data" type="application/json">
{{ $searchIndex | jsonify }}
</script>

<script>
// Lightweight search implementation - much simpler than the complex search engine
let searchData = [];
let searchTimeout;

// Initialize search data
document.addEventListener('DOMContentLoaded', function() {
  const dataScript = document.getElementById('search-data');
  if (dataScript) {
    try {
      searchData = JSON.parse(dataScript.textContent);
    } catch (error) {
      console.error('Failed to parse search data:', error);
    }
  }
});

function performSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    const startTime = performance.now();
    
    const query = document.getElementById('search-query').value.toLowerCase().trim();
    const level = document.getElementById('search-level').value;
    const category = document.getElementById('search-category').value;
    const sortBy = document.getElementById('search-sort').value;
    
    let results = searchData;
    
    // Apply filters
    if (level) {
      results = results.filter(item => item.level === level);
    }
    
    if (category) {
      results = results.filter(item => item.category === category);
    }
    
    // Apply search query
    if (query) {
      results = results.filter(item => {
        return item.searchText.toLowerCase().includes(query) ||
               item.word.toLowerCase().includes(query) ||
               item.translation.toLowerCase().includes(query);
      }).map(item => {
        // Calculate simple relevance score
        let score = 0;
        const searchText = item.searchText.toLowerCase();
        
        if (item.word.toLowerCase().includes(query)) score += 10;
        if (item.translation.toLowerCase().includes(query)) score += 8;
        if (item.category.toLowerCase().includes(query)) score += 5;
        if (searchText.includes(query)) score += 1;
        
        return { ...item, relevanceScore: score };
      });
    }
    
    // Sort results
    switch (sortBy) {
      case 'alphabetical':
        results.sort((a, b) => a.word.localeCompare(b.word));
        break;
      case 'difficulty':
        results.sort((a, b) => a.difficulty - b.difficulty);
        break;
      case 'frequency':
        results.sort((a, b) => b.frequency - a.frequency);
        break;
      case 'relevance':
      default:
        if (query) {
          results.sort((a, b) => (b.relevanceScore || 0) - (a.relevanceScore || 0));
        }
        break;
    }
    
    const endTime = performance.now();
    displayResults(results, query, endTime - startTime);
  }, 300);
}

function displayResults(results, query, searchTime) {
  const resultsContainer = document.getElementById('search-results');
  const noResults = document.getElementById('no-results');
  const resultsCount = document.getElementById('search-results-count');
  const searchTimeSpan = document.getElementById('search-time');
  
  resultsCount.textContent = `${results.length} items`;
  searchTimeSpan.textContent = `(${searchTime.toFixed(1)}ms)`;
  
  if (results.length === 0 && query) {
    resultsContainer.innerHTML = '';
    noResults.classList.remove('hidden');
    return;
  }
  
  noResults.classList.add('hidden');
  
  if (!query && results.length === searchData.length) {
    resultsContainer.innerHTML = `
      <div class="initial-message">
        <p>Start typing to search vocabulary items...</p>
        <div class="search-suggestions">
          <h4>Popular searches:</h4>
          <button onclick="searchFor('Begrüßung')" class="suggestion-btn">Greetings</button>
          <button onclick="searchFor('Familie')" class="suggestion-btn">Family</button>
          <button onclick="searchFor('Essen')" class="suggestion-btn">Food</button>
          <button onclick="searchFor('A1')" class="suggestion-btn">A1 Level</button>
        </div>
      </div>
    `;
    return;
  }
  
  // Render results using the vocab-card shortcode structure
  resultsContainer.innerHTML = results.map(item => `
    <div class="vocab-card search-result" data-word="${item.word.toLowerCase()}" data-translation="${item.translation.toLowerCase()}" data-level="${item.level}" data-category="${item.category}">
      <div class="vocab-card-inner">
        <div class="vocab-card-front">
          <div class="vocab-word">${highlightMatch(item.word, query)}</div>
          <div class="vocab-meta">
            <span class="level-badge level-${item.level.toLowerCase()}">${item.level}</span>
            <span class="category-tag">${item.category}</span>
            <span class="difficulty-indicator" title="Difficulty: ${item.difficulty}/5">
              ${'★'.repeat(item.difficulty)}${'☆'.repeat(5 - item.difficulty)}
            </span>
          </div>
        </div>
        <div class="vocab-card-back">
          <div class="vocab-translation">${highlightMatch(item.translation, query)}</div>
          ${item.notes ? `<div class="vocab-notes">${highlightMatch(item.notes, query)}</div>` : ''}
          ${item.etymology ? `<div class="vocab-etymology"><strong>Etymology:</strong> ${item.etymology}</div>` : ''}
          ${item.cultural_note ? `<div class="vocab-cultural-note"><strong>Cultural Note:</strong> ${item.cultural_note}</div>` : ''}
          ${item.linguistic_note ? `<div class="vocab-linguistic-note"><strong>Linguistic Note:</strong> ${item.linguistic_note}</div>` : ''}
        </div>
      </div>
      <div class="vocab-card-actions">
        <button class="flip-btn" onclick="this.closest('.vocab-card').classList.toggle('flipped')">↻</button>
        <button class="practice-btn" data-word="${item.word}">Practice</button>
        <input type="checkbox" class="select-checkbox" data-word="${item.word}">
      </div>
    </div>
  `).join('');
}

function highlightMatch(text, query) {
  if (!query || !text) return text;
  
  const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
  return text.replace(regex, '<mark>$1</mark>');
}

function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function searchFor(term) {
  document.getElementById('search-query').value = term;
  performSearch();
}

function clearSearch() {
  document.getElementById('search-query').value = '';
  document.getElementById('search-level').value = '';
  document.getElementById('search-category').value = '';
  document.getElementById('search-sort').value = 'relevance';
  performSearch();
}
</script>
