{{/* 
  Vocabulary Grid Shortcode - Server-side rendered vocabulary grid with filtering
  Usage: {{< vocab-grid category="Begrüßung" level="A1" limit="20" >}}
*/}}

{{ $category := .Get "category" }}
{{ $level := .Get "level" }}
{{ $limit := .Get "limit" | default 50 | int }}
{{ $shuffle := .Get "shuffle" | default false }}
{{ $showFilters := .Get "showFilters" | default true }}

{{/* Get vocabulary data */}}
{{ $vocabulary := .Site.Data.vocabulary }}

{{/* Apply filters */}}
{{ if $category }}
  {{ $vocabulary = where $vocabulary "category" $category }}
{{ end }}

{{ if $level }}
  {{ $vocabulary = where $vocabulary "level" $level }}
{{ end }}

{{/* Shuffle if requested */}}
{{ if $shuffle }}
  {{ $vocabulary = shuffle $vocabulary }}
{{ end }}

{{/* Apply limit */}}
{{ $vocabulary = first $limit $vocabulary }}

{{/* Get unique categories and levels for filters */}}
{{ $categories := slice }}
{{ $levels := slice }}
{{ range .Site.Data.vocabulary }}
  {{ $categories = $categories | append .category }}
  {{ $levels = $levels | append .level }}
{{ end }}
{{ $categories = $categories | uniq | sort }}
{{ $levels = $levels | uniq | sort }}

<div class="vocab-grid-container">
  {{ if $showFilters }}
  <div class="vocab-filters">
    <div class="filter-group">
      <label for="level-filter">Level:</label>
      <select id="level-filter" onchange="filterVocabulary()">
        <option value="">All Levels</option>
        {{ range $levels }}
        <option value="{{ . }}" {{ if eq . $level }}selected{{ end }}>{{ . }}</option>
        {{ end }}
      </select>
    </div>
    
    <div class="filter-group">
      <label for="category-filter">Category:</label>
      <select id="category-filter" onchange="filterVocabulary()">
        <option value="">All Categories</option>
        {{ range $categories }}
        <option value="{{ . }}" {{ if eq . $category }}selected{{ end }}>{{ . }}</option>
        {{ end }}
      </select>
    </div>
    
    <div class="filter-group">
      <label for="search-input">Search:</label>
      <input type="text" id="search-input" placeholder="Search vocabulary..." oninput="debounceSearch()">
    </div>
    
    <div class="filter-actions">
      <button onclick="clearFilters()" class="btn-secondary">Clear Filters</button>
      <button onclick="practiceSelected()" class="btn-primary" id="practice-btn" disabled>
        Practice Selected (0)
      </button>
    </div>
  </div>
  {{ end }}
  
  <div class="vocab-stats">
    <span>Showing <span id="showing-count">{{ len $vocabulary }}</span> of {{ len .Site.Data.vocabulary }} words</span>
    <span id="selected-count-display" class="selected-count">0 selected</span>
  </div>
  
  <div class="vocab-grid" id="vocab-grid">
    {{ range $vocabulary }}
    <div class="vocab-card" 
         data-word="{{ .word | lower }}" 
         data-translation="{{ .translation | lower }}"
         data-level="{{ .level }}" 
         data-category="{{ .category }}"
         data-difficulty="{{ .difficulty | default 1 }}"
         data-frequency="{{ .frequency | default 1 }}"
         {{ if .id }}data-id="{{ .id }}"{{ end }}>
      
      <div class="vocab-card-inner">
        <div class="vocab-card-front">
          <div class="vocab-word">{{ .word }}</div>
          
          <div class="vocab-meta">
            {{ if .level }}
            <span class="level-badge level-{{ .level | lower }}">{{ .level }}</span>
            {{ end }}
            {{ if .category }}
            <span class="category-tag">{{ .category }}</span>
            {{ end }}
            {{ if .difficulty }}
            {{ $difficultyInt := .difficulty | int }}
            <span class="difficulty-indicator" title="Difficulty: {{ $difficultyInt }}/5">
              {{ range seq $difficultyInt }}★{{ end }}{{ range seq (sub 5 $difficultyInt) }}☆{{ end }}
            </span>
            {{ end }}
          </div>
        </div>
        
        <div class="vocab-card-back">
          <div class="vocab-translation">{{ .translation }}</div>
          
          {{ if .notes }}
          <div class="vocab-notes">{{ .notes | markdownify }}</div>
          {{ end }}
          
          {{ if .etymology }}
          <div class="vocab-etymology">
            <strong>Etymology:</strong> {{ .etymology }}
          </div>
          {{ end }}
          
          {{ if .cultural_note }}
          <div class="vocab-cultural-note">
            <strong>Cultural Note:</strong> {{ .cultural_note }}
          </div>
          {{ end }}
          
          {{ if .linguistic_note }}
          <div class="vocab-linguistic-note">
            <strong>Linguistic Note:</strong> {{ .linguistic_note }}
          </div>
          {{ end }}
        </div>
      </div>
      
      <div class="vocab-card-actions">
        <button class="flip-btn" onclick="this.closest('.vocab-card').classList.toggle('flipped')" aria-label="Flip card">
          <span class="flip-icon">↻</span>
        </button>
        <button class="practice-btn" data-word="{{ .word }}" aria-label="Practice this word">
          Practice
        </button>
        <input type="checkbox" class="select-checkbox" data-word="{{ .word }}" aria-label="Select for practice">
      </div>
    </div>
    {{ end }}
  </div>
  
  {{ if eq (len $vocabulary) 0 }}
  <div class="no-results">
    <p>No vocabulary items found matching your criteria.</p>
    <button onclick="clearFilters()" class="btn-secondary">Clear Filters</button>
  </div>
  {{ end }}
</div>

<script>
// Minimal JavaScript for filtering - much less than before
let selectedWords = new Set();
let searchTimeout;

function filterVocabulary() {
  const level = document.getElementById('level-filter').value;
  const category = document.getElementById('category-filter').value;
  const search = document.getElementById('search-input').value.toLowerCase();
  
  const cards = document.querySelectorAll('.vocab-card');
  let visibleCount = 0;
  
  cards.forEach(card => {
    const cardLevel = card.dataset.level;
    const cardCategory = card.dataset.category;
    const cardWord = card.dataset.word;
    const cardTranslation = card.dataset.translation;
    
    const levelMatch = !level || cardLevel === level;
    const categoryMatch = !category || cardCategory === category;
    const searchMatch = !search || 
      cardWord.includes(search) || 
      cardTranslation.includes(search);
    
    if (levelMatch && categoryMatch && searchMatch) {
      card.style.display = 'block';
      visibleCount++;
    } else {
      card.style.display = 'none';
    }
  });
  
  document.getElementById('showing-count').textContent = visibleCount;
}

function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(filterVocabulary, 300);
}

function clearFilters() {
  document.getElementById('level-filter').value = '';
  document.getElementById('category-filter').value = '';
  document.getElementById('search-input').value = '';
  filterVocabulary();
}

function practiceSelected() {
  if (selectedWords.size === 0) {
    alert('Please select some words to practice.');
    return;
  }
  
  // Store selected words for practice
  localStorage.setItem('bgde:practice_selection', JSON.stringify(Array.from(selectedWords)));
  window.location.href = '/practice/';
}

// Handle card selection
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('select-checkbox')) {
    const word = e.target.dataset.word;
    if (e.target.checked) {
      selectedWords.add(word);
    } else {
      selectedWords.delete(word);
    }
    
    const practiceBtn = document.getElementById('practice-btn');
    practiceBtn.disabled = selectedWords.size === 0;
    practiceBtn.textContent = `Practice Selected (${selectedWords.size})`;
    
    document.getElementById('selected-count-display').textContent = `${selectedWords.size} selected`;
  }
});
</script>
