{{- $vocabulary := .Site.Data.vocabulary -}}
{{- $page := .Params.page | default 1 -}}
{{- $limit := .Params.limit | default 50 -}}
{{- $category := .Params.category | default "" -}}
{{- $level := .Params.level | default "" -}}
{{- $search := .Params.search | default "" -}}
{{- $direction := .Params.direction | default "bg-de" -}}

{{- /* Filter vocabulary based on parameters */ -}}
{{- $filtered := slice -}}
{{- range $vocabulary -}}
  {{- $include := true -}}
  
  {{- /* Category filter */ -}}
  {{- if and $category (ne $category "") -}}
    {{- if ne .category $category -}}
      {{- $include = false -}}
    {{- end -}}
  {{- end -}}
  
  {{- /* Level filter */ -}}
  {{- if and $level (ne $level "") -}}
    {{- if ne .level $level -}}
      {{- $include = false -}}
    {{- end -}}
  {{- end -}}
  
  {{- /* Search filter */ -}}
  {{- if and $search (ne $search "") -}}
    {{- $searchLower := lower $search -}}
    {{- $wordMatch := or (in (lower .word) $searchLower) (in (lower .translation) $searchLower) -}}
    {{- $notesMatch := false -}}
    {{- if .notes -}}
      {{- $notesMatch = in (lower .notes) $searchLower -}}
    {{- end -}}
    {{- if not (or $wordMatch $notesMatch) -}}
      {{- $include = false -}}
    {{- end -}}
  {{- end -}}
  
  {{- if $include -}}
    {{- $filtered = $filtered | append . -}}
  {{- end -}}
{{- end -}}

{{- /* Calculate pagination */ -}}
{{- $total := len $filtered -}}
{{- $totalPages := div (add $total (sub $limit 1)) $limit -}}
{{- $offset := mul (sub $page 1) $limit -}}
{{- $items := after $offset (first (add $offset $limit) $filtered) -}}

{{- /* Build response */ -}}
{
  "vocabulary": [
    {{- range $index, $item := $items -}}
    {{- if gt $index 0 -}},{{- end -}}
    {
      "id": {{ $item.id | jsonify }},
      "word": {{ $item.word | jsonify }},
      "translation": {{ $item.translation | jsonify }},
      "source_lang": {{ $item.source_lang | default "bg" | jsonify }},
      "target_lang": {{ $item.target_lang | default "de" | jsonify }},
      "category": {{ $item.category | jsonify }},
      "level": {{ $item.level | jsonify }},
      "notes": {{ $item.notes | default "" | jsonify }},
      "etymology": {{ $item.etymology | default "" | jsonify }},
      "cultural_note": {{ $item.cultural_note | default "" | jsonify }},
      "linguistic_note": {{ $item.linguistic_note | default "" | jsonify }},
      "difficulty": {{ $item.difficulty | default 1 }},
      "frequency": {{ $item.frequency | default 1 }},
      "examples": {{ $item.examples | default (slice) | jsonify }},
      "audio_url": {{ printf "/audio/%s.mp3" $item.word | jsonify }},
      "slug": {{ $item.word | urlize | jsonify }}
    }
    {{- end -}}
  ],
  "pagination": {
    "page": {{ $page }},
    "limit": {{ $limit }},
    "total": {{ $total }},
    "total_pages": {{ $totalPages }},
    "has_prev": {{ gt $page 1 }},
    "has_next": {{ lt $page $totalPages }},
    "prev_page": {{ if gt $page 1 }}{{ sub $page 1 }}{{ else }}null{{ end }},
    "next_page": {{ if lt $page $totalPages }}{{ add $page 1 }}{{ else }}null{{ end }}
  },
  "filters": {
    "category": {{ $category | jsonify }},
    "level": {{ $level | jsonify }},
    "search": {{ $search | jsonify }},
    "direction": {{ $direction | jsonify }}
  },
  "meta": {
    "generated_at": {{ now.Format "2006-01-02T15:04:05Z07:00" | jsonify }},
    "cache_key": {{ printf "vocab-%s-%s-%s-%s-%d-%d" $category $level $search $direction $page $limit | sha256 | jsonify }},
    "api_version": "1.0.0"
  }
}
