{{ if .Site.Params.enablePWA }}
<script>
// Progressive Web App registration and update handling
const __isDev = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

if ('serviceWorker' in navigator) {
  if (__isDev) {
    console.log('Skipping SW registration in dev');
  } else {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('{{ "sw.js" | relURL }}')
        .then((registration) => {
          console.log('SW registered: ', registration);
          
          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // New content available, show update notification
                showUpdateNotification();
              }
            });
          });

          navigator.serviceWorker.ready.then((readyRegistration) => {
            try {
              const precacheNode = document.getElementById('bgde-precache-assets');
              if (!precacheNode || !precacheNode.textContent) {
                return;
              }
              const urls = JSON.parse(precacheNode.textContent).filter(Boolean);
              if (!Array.isArray(urls) || !urls.length) {
                return;
              }
              const activeWorker = readyRegistration.active || registration.active;
              if (activeWorker) {
                activeWorker.postMessage({ type: 'PRECACHE_URLS', urls });
              }
            } catch (error) {
              console.warn('[PWA] Failed to send precache asset list:', error);
            }
          });
        })
        .catch((registrationError) => {
          console.log('SW registration failed: ', registrationError);
        });
    });

    // Listen for messages from service worker
    navigator.serviceWorker.addEventListener('message', (event) => {
      if (event.data.type === 'SW_ACTIVATED') {
        console.log('Service Worker activated:', event.data.version);
      }
    });
  }
}

function showUpdateNotification() {
  // Create update notification
  const notification = document.createElement('div');
  notification.className = 'update-notification';
  notification.innerHTML = `
    <div class="update-content">
      <span>New version available!</span>
      <button onclick="updateApp()" class="update-btn">Update</button>
      <button onclick="dismissUpdate(this)" class="dismiss-btn">Ã—</button>
    </div>
  `;
  document.body.appendChild(notification);
}

function updateApp() {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistration().then((registration) => {
      if (registration && registration.waiting) {
        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
        window.location.reload();
      }
    });
  }
}

function dismissUpdate(btn) {
  btn.closest('.update-notification').remove();
}

// Install prompt handling
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install button if not already installed
  const installBtn = document.getElementById('install-btn');
  if (installBtn) {
    installBtn.style.display = 'block';
    installBtn.addEventListener('click', () => {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('User accepted the install prompt');
        }
        deferredPrompt = null;
        installBtn.style.display = 'none';
      });
    });
  }
});
</script>

<style>
.update-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #007bff;
  color: white;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 10000;
  max-width: 300px;
}

.update-content {
  display: flex;
  align-items: center;
  gap: 12px;
}

.update-btn {
  background: white;
  color: #007bff;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
}

.dismiss-btn {
  background: none;
  border: none;
  color: white;
  font-size: 18px;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#install-btn {
  display: none;
  background: #28a745;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  margin: 8px 0;
}
</style>
{{ end }}
