{{ if .Site.Params.googleAnalytics }}
<!-- Google Analytics 4 -->
<script async src="https://www.googletagmanager.com/gtag/js?id={{ .Site.Params.googleAnalytics }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', '{{ .Site.Params.googleAnalytics }}', {
    page_title: '{{ .Title }}',
    page_location: '{{ .Permalink }}',
    content_group1: '{{ .Section }}',
    custom_map: {
      'dimension1': 'learning_language',
      'dimension2': 'session_type',
      'dimension3': 'vocabulary_level'
    }
  });
  
  // Custom events for learning app
  function trackLearningEvent(action, category, label, value) {
    gtag('event', action, {
      event_category: category,
      event_label: label,
      value: value
    });
  }
  
  // Track vocabulary interactions
  window.trackVocabView = function(wordId, level) {
    trackLearningEvent('view_vocabulary', 'vocabulary', wordId, 1);
    gtag('event', 'view_vocabulary', {
      vocabulary_id: wordId,
      vocabulary_level: level
    });
  };
  
  // Track practice sessions
  window.trackPracticeSession = function(sessionType, wordsCount, accuracy) {
    trackLearningEvent('practice_session', 'learning', sessionType, wordsCount);
    gtag('event', 'practice_complete', {
      session_type: sessionType,
      words_practiced: wordsCount,
      accuracy_rate: accuracy
    });
  };
  
  // Track flashcard interactions
  window.trackFlashcardGrade = function(grade, wordId) {
    trackLearningEvent('flashcard_grade', 'spaced_repetition', `grade_${grade}`, 1);
    gtag('event', 'flashcard_graded', {
      grade: grade,
      vocabulary_id: wordId
    });
  };
</script>
{{ end }}

{{ if .Site.Params.plausibleDomain }}
<!-- Plausible Analytics -->
<script defer data-domain="{{ .Site.Params.plausibleDomain }}" src="https://plausible.io/js/script.js"></script>
<script>
  window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments) }
  
  // Custom events for Plausible
  window.trackVocabView = function(wordId, level) {
    plausible('Vocabulary View', {props: {word: wordId, level: level}});
  };
  
  window.trackPracticeSession = function(sessionType, wordsCount, accuracy) {
    plausible('Practice Session', {props: {
      type: sessionType,
      words: wordsCount,
      accuracy: Math.round(accuracy * 100)
    }});
  };
  
  window.trackFlashcardGrade = function(grade, wordId) {
    plausible('Flashcard Grade', {props: {grade: grade, word: wordId}});
  };
</script>
{{ end }}

{{ if hugo.IsProduction }}
<!-- Performance monitoring -->
<script>
  // Core Web Vitals tracking
  function getCLS(onPerfEntry) {
    import('web-vitals').then(({getCLS}) => getCLS(onPerfEntry));
  }
  
  function getFID(onPerfEntry) {
    import('web-vitals').then(({getFID}) => getFID(onPerfEntry));
  }
  
  function getFCP(onPerfEntry) {
    import('web-vitals').then(({getFCP}) => getFCP(onPerfEntry));
  }
  
  function getLCP(onPerfEntry) {
    import('web-vitals').then(({getLCP}) => getLCP(onPerfEntry));
  }
  
  function getTTFB(onPerfEntry) {
    import('web-vitals').then(({getTTFB}) => getTTFB(onPerfEntry));
  }
  
  function sendToAnalytics(metric) {
    if (typeof gtag !== 'undefined') {
      gtag('event', metric.name, {
        event_category: 'Web Vitals',
        value: Math.round(metric.name === 'CLS' ? metric.value * 1000 : metric.value),
        event_label: metric.id,
        non_interaction: true,
      });
    }
    
    if (typeof plausible !== 'undefined') {
      plausible('Web Vital', {props: {
        metric: metric.name,
        value: Math.round(metric.name === 'CLS' ? metric.value * 1000 : metric.value)
      }});
    }
  }
  
  // Track Core Web Vitals
  getCLS(sendToAnalytics);
  getFID(sendToAnalytics);
  getFCP(sendToAnalytics);
  getLCP(sendToAnalytics);
  getTTFB(sendToAnalytics);
</script>
{{ end }}
